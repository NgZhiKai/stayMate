# name: Frontend Deploy

# on:
#   workflow_call:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         working-directory: frontend/hotel-booking-frontend

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: Install dependencies and build
#         run: |
#           npm install
#           npm run build

#       - name: Deploy to GitHub Pages
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: frontend/hotel-booking-frontend/dist



name: Build, Push Docker & Deploy to GitHub Pages

on:
  workflow_call:

jobs:
  build_and_push_docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/hotel-booking-frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ vars.DOCKER_PASSWORD }}

      - name: Determine next Docker version tag
        id: get_tag
        run: |
          tags=$(curl -s https://hub.docker.com/v2/repositories/ngzhikai/staymate-app/tags | jq -r '.results[].name' | grep '^frontend-version' || echo "")
          if [ -z "$tags" ]; then
            next_tag="frontend-version1"
          else
            latest_version=$(echo "$tags" | sed 's/frontend-version//' | sort -n | tail -n 1)
            next=$((latest_version + 1))
            next_tag="frontend-version$next"
          fi
          echo "Next tag: $next_tag"
          echo "DOCKER_TAG=$next_tag" >> $GITHUB_ENV

      - name: Build and push frontend Docker image
        run: |
          docker build -t ngzhikai/staymate-app:frontend-latest \
                       -t ngzhikai/staymate-app:${{ env.DOCKER_TAG }} .

          docker push ngzhikai/staymate-app:frontend-latest
          docker push ngzhikai/staymate-app:${{ env.DOCKER_TAG }}

  pull_and_deploy_gh_pages:
    name: Pull Docker Image & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build_and_push_docker
    defaults:
      run:
        working-directory: frontend/hotel-booking-frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull Docker image
        run: |
          docker pull ngzhikai/staymate-app:frontend-latest

      - name: Extract files from Docker container and deploy to GitHub Pages
        run: |
          container_id=$(docker create ngzhikai/staymate-app:frontend-latest)
          docker cp $container_id:/app/frontend/dist ./frontend/dist
          docker rm $container_id
          
          # Deploy to GitHub Pages
          npm install -g gh-pages
          gh-pages -d frontend/dist -r https://github.com/${{ github.repository }} -b gh-pages

